---
version: 1
kind: component
meta:
  name: spinnaker
  brief: Spinnaker CD Server
  source:
      dir: ../../components/spinnaker

# requires:
#   - kubernetes

parameters:
  - name: terraform.bucket.name
    env: TF_VAR_backend_bucket
  - name: terraform.bucket.region
    env: TF_VAR_backend_region
  - name: cloud.region
    kind: user
    env: AWS_DEFAULT_REGION
  - name: cloud.sshKey
    default: agilestacks
    env: AWS_KEYPAIR
  - name: cloud.bucket
    kind: tech
    brief: Bucket for Spinnaker. Coming from basestack
    env: AWS_S3_BUCKET
  - name: dns.domain
    brief: DNS domain
    kind: tech
    env: DOMAIN_NAME
  - name: cloud.role.master
    default: unknown
  - name: component.ingress.fqdn
    value: app.${dns.domain}
    env: INGRESS_FQDN
  - name: component.spinnaker
    parameters:
    - name: name
      default: spinnaker
      env: COMPONENT_NAME
    - name: namespace
      brief: Kubernetes namespace to install into
      default: spinnaker
      env: NAMESPACE
    - name: ingress
      value: spinnaker.${component.ingress.fqdn}
      env: SPINNAKER_INGRESS
    - name: aws.assume_role
      value: ${cloud.role.master}
      env: AWS_ASSUME_ROLE
    - name: aws.keypair
      default: agilestacks
      env: AWS_KEY_PAIR
    - name: slack.bot_token
      default: unknown
      env: SLACK_TOKEN
    - name: aws.accountName
      default: aws
      env: AWS_ACCOUNT_NAME
    - name: kubernetes.accountName
      default: aws
      env: K8S_ACCOUNT_NAME
  - name: component.jenkins
    parameters:
    - name: fqdn
      default: unknown
      env: JENKINS_FQDN
    - name: internal.url
      default: unknown
      env: JENKINS_ADDRESS
    - name: serviceaccount.user
      default: robot
      env: JENKINS_USER
    - name: serviceaccount.password
      default: robot
      env: JENKINS_PASSWORD

outputs:
- name:  component.spinnaker.fqdn
  value: ${component.spinnaker.name}.${component.ingress.fqdn}

templates:
  files:
    - "*.template"
