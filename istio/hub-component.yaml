---
version: 1
kind: component
meta:
  name: istio
  title: Istio
  brief: Service mesh
  description: An open platform to connect, manage, control, secure and observe services.
  category: Networking
  version: 1.3.0
  maturity: beta
  license: Apache 2.0
  source:
    dir: ../../components/istio

requires:
  - aws
  - kubernetes
  - helm
  - tiller

provides:
  - istio

parameters:
  - name: dns.domain
    env: DOMAIN_NAME
  - name: component.ingress.protocol
  - name: component.ingress.fqdn
  - name: component.ingress.ssoFqdn
  - name: cloud.kind
    env: CLOUD_KIND
  - name: terraform.bucket.region
    env: STATE_REGION
  - name: terraform.bucket.name
    env: STATE_BUCKET
  - name: component.istio
    parameters:
      - name: namespace
        value: istio-system
        env: NAMESPACE
      - name: version.release
        value: 1.3.2
        env: ISTIO_VERSION
      - name: version.repository
        value: gcr.io/istio-release
      - name: version.image
        value: release-1.3-latest-daily
      - name: tracing.enabled
        value: false
      - name: prometheus.enabled
        value: true
      - name: grafana.enabled
        value: false
      - name: certmanager.enabled
        value: false
      - name: ingressGateway.default.dnsZone
        value: mesh
        env: DEFAULT_GATEWAY_ZONE
      - name: ingressGateway.default.name
        value: default-ingressgateway
        env: DEFAULT_INGRESS_GATEWAY
      - name: kiali
        parameters:
          - name: enabled
            value: true
          - name: urlPrefix
            value: istio-kiali
          - name: auth.strategy
            value: anonymous
          - name: version.image
            value: v1.4
          - name: createDemoSecret
            value: '#{component.istio.kiali.auth.strategy == "login" ? "true" : "false"}'

outputs:
  - name: component.istio.kiali.url
    brief: Istio Service Graph
    value: ${component.ingress.protocol}://${component.istio.kiali.urlPrefix}.${component.ingress.ssoFqdn}
  - name: component.istio.ingressGateway.default.fqdn
    value: ${component.istio.ingressGateway.default.dnsZone}.${dns.domain}
  - name: component.istio.ingressGateway.default.name

templates:
  files:
    - "*.template"
