---
version: 1
kind: component
meta:
  name: gitlab-cn
  title: GitLab
  brief: Enterprise web based Git and CI/CD
  description: >
    GitLab includes Git repository management, issue tracking, code review, an IDE, activity streams, wikis, and more.
  category: DevOps Stack
  version: 12.4.5
  maturity: ga
  license: MIT
  source:
    dir: ../../components/gitlab-cn

requires:
  - aws
  - azure
  - gcp
  - kubernetes
  - helm
  - tiller

provides:
  - gitlab

parameters:
  - name: terraform.bucket.name
    env: STATE_BUCKET
  - name: terraform.bucket.region
    env: STATE_REGION
  - name: terraform.bucket.container
    empty: allow
    env: STATE_CONTAINER
  - name: cloud.kind
    env: CLOUD_KIND
  - name: dns.domain
    env: TF_VAR_domain_name
  - name: dns.name
  - name: cloud.azureResourceGroupName
    env: TF_VAR_azure_resource_group_name
    empty: allow
  - name: cloud.gcpProjectId
    empty: allow
    env: TF_VAR_gcp_project_id
  - name: component.ingress.kubernetes.ingressClass
    empty: allow
  - name: component.ingress.protocol
    env: PROTOCOL
  - name: component.acm.certificateArn
    empty: allow
    env: ACM_CERTIFICATE_ARN
  - name: component.tls.kind
    value: letsencrypt
    env: TLS_KIND
    empty: allow
  - name: component.gitlab
    parameters:
    - name: name
      env: TF_VAR_component
      value: gitlab-cn
    - name: chart
      value: gitlab
      env: HELM_CHART
    - name: repo
      value: https://charts.gitlab.io
      env: HELM_REPO
    - name: chart.version
      value: 2.4.13
      env: CHART_VERSION
    - name:  name
      value: gitlab-cn
      env:   TF_VAR_component
    - name: edition
      value: ce
    - name:  namespace
      brief: Kubernetes namespace to install into
      value: gitlab
      env:   TF_VAR_namespace
    - name:  software.version
      brief: Gitlab Version
      value: 12.4.8
    - name:  rbac.enabled
      value: true
    - name:  psp.enabled
      value: true
    - name:  ingress.enabled
      value: true
    - name:  ingress.path
      value: /
    - name: serviceaccount.username
      value: ""
      empty: allow
      env: GITLAB_SERVICEACCOUNT
    - name: serviceaccount.password
      value: ""
      empty: allow
      env: GITLAB_SERVICEACCOUNT_PASS
    - name: fqdn
      value: gitlab.${dns.domain}
    - name: registry.fqdn
      value: registry.${dns.domain}
    - name: url
      value: ${component.ingress.protocol}://${component.gitlab.fqdn}
      env: GITLAB_URL
    - name: registryUrl
      value: ${component.ingress.protocol}://${component.gitlab.registry.fqdn}
    - name: omniauth
      parameters:
      - name: provider.name
        value: okta
      - name: identifier
        value: gitlab-client
      - name: secret
        value: dpKSSpLzY3pt-QZvmKjccmm8A
      - name: callback.url
        value: ${component.gitlab.url}/users/auth/${component.gitlab.omniauth.provider.name}/callback
  - name: component.dex.issuer
  - name: component.minio.secret
  - name: component.bucket
    parameters:
    - name: namespace
    - name: name
    - name: accessKey
    - name: secretKey
    - name: endpoint

templates:
  files:
    - "*.template"
    - "aws/*/*.yaml.template"
  extra:
    - kind: mustache
      files:
        - "scripts/*.template"
        - "aws/*.yaml.template"
        - "aws/*.sh.template"
        - "azure/*.yaml.template"
        - "azure/*.sh.template"
        - "gcp/*.yaml.template"
        - "gcp/*.sh.template"
outputs:
  - name: component.gitlab.url
    brief: Gitlab URL
    value: ${component.gitlab.url}
  - name: component.gitlab.server.endpoint
    brief: Gitlab API
    value: ${component.gitlab.url}/api/v4
  - name: component.gitlab.registryUrl
    brief: Gitlab Registry URL
  - name: component.gitlab.namespace
    brief: Gitlab default group
  - name: component.gitlab.token
    kind: secret
    fromTfVar: serviceaccount_token
