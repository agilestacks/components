---
version: 1
kind: component
meta:
  name: kubeflow
  title: Kubeflow
  brief: Machine learning
  description: >
    Kubeflow is an open source machine learning platform built on top of Kubernetes.
  category: AI and Machine Learning
  version: 1.1.0
  maturity: ga
  licence: Apache 2.0
  source:
    dir: ../../components/kubeflow-v1.0

requires:
  - kubernetes
  # - ingress
  # - istio

provides:
  - kubeflow
  # - istio

parameters:
- name: dns.domain
  env: HUB_DOMAIN_NAME
- name: component.dex
  parameters:
  - name: issuer
    env: HUB_DEX_ISSUER
  - name: component.dex.namespace
    value: dex
    env: HUB_DEX_NAMESPACE
  - name: passwordDb.email
    value: support@agilestacks.com
    empty: allow
- name: component.kubeflow
  parameters:
    # To deploy multiple kubeflow on the same cluster
    # will require to separate it by the namespace
    # we will use a component..name for namespace
    - name: name
      value: kubeflow
      env: HUB_COMPONENT_NAME
    - name: namespace
      value: kubeflow
      env: HUB_COMPONENT_NAMESPACE
    - name: version
      value: v1.1.0
      env: HUB_COMPONENT_VERSION
    - name: oidc.authURI
      value: ${component.dex.issuer}
      env: HUB_OIDC_AUTH_URI
    - name: oidc.clientId
      value: ${component.kubeflow.name}-client
      env: HUB_OIDC_CLIENT_ID
    - name: oidc.secret
      # mutual trust secret between dex and kubeflow
      # must be changed by the user to smth really random
      # At present this is in sync to the defaults in `istio/oidc-authservice` kfapp
      value: pUBnBOY80SnXgjibTYM9ZWNzY2xreNGQok
      env: HUB_OIDC_SECRET
    - name: oidc.redirectURI
      value: ${component.ingress.protocol}://${component.kubeflow.name}.${dns.domain}/login/oidc
      env: HUB_OIDC_REDIRECT_URI
    - name: profile.owner.username
      value: ${component.dex.passwordDb.email}
      env: HUB_DEX_USER
- name: component.ingress.protocol
  value: https
- name: component.istio
  parameters:
  - name: namespace
    value: istio-system
    env: HUB_ISTIO_NAMESPACE
  - name: ingressGateway
# - name: component.minio.namespace
#   value: ${component.kubeflow.namespace}
- name: component.knative-serving.namespace
  value: knative-serving
  env: HUB_KNATIVE_SERVING_NAMESPACE
  empty: allow
- name: component.bucket
  parameters:
  - name: endpoint
    env: HUB_S3_ENDPOINT
  - name: region
    env: HUB_S3_REGION
  - name: accessKey
    env: HUB_S3_ACCESS_KEY
  - name: secretKey
    env: HUB_S3_SECRET_KEY
  - name: name
    env: HUB_S3_BUCKET
    value: ${component.kubeflow.name}-pipelines
- name: component.mysql
  empty: allow
  parameters:
  - name: host
    value: mysql
    env: HUB_MYSQL_HOST
  - name: user
    env: HUB_MYSQL_DB_USER
  - name: password
    env: HUB_MYSQL_DB_PASS
  - name: database
    env: HUB_MYSQL_DB_NAME
    value: mlpipeline
- name: component.cert-manager
  parameters:
    # see: ClusterIssuers generated by `cert-manager` component
    # for current defaults rationale
  - name: dnsIssuerName
    value: letsencrypt-prod-dns
  - name: dnsIssuerKind
    value: ClusterIssuer

outputs:
- name: component.kubeflow.url
  brief: Kubeflow Central Dashboard
  value: ${component.ingress.protocol}://${component.kubeflow.name}.${dns.domain}/

templates:
  files:
    - ext/argo/overlays/agilestacks/*.template
    - ext/istio/istio/overlays/agilestacks/*.template
    - ext/istio/add-anonymous-user-filter/overlays/agilestacks/*.template
    - ext/istio/oidc-authservice/overlays/agilestacks/*.template
    - ext/knative/knative-serving-install/overlays/agilestacks/*.template
    - ext/profiles/overlays/agilestacks/*.template
    - ext/common/centraldashboard/base/*.template
    - ext/metadata/overlays/agilestacks/*.template
    - "k8s/*.template"
