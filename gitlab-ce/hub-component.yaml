---
version: 1
kind: component
meta:
  name: gitlab-ce
  brief: gitlab-ce
  source:
      dir: ../../components/gitlab-ce

provides:
  - gitlab-ce

parameters:
  - name: component.ingress.ssoUrlPrefix
    value: auth
  - name: component.ingress.protocol
    value: https
  - name: component.ingress.fqdn
    value: app.${dns.domain}
    env: INGRESS_FQDN
  - name: component.dex.issuer
  - name: dns.domain
    env: DOMAIN_NAME
  - name: component.postgresql
    parameters:
    - name: host
    - name: database
    - name: user
    - name: password
  - name: component.gitlab-ce
    parameters:
    - name: acm_certificate.arn
      value: ${component.acm.certificateArn}
      env: ACM_CERTIFICATE_ARN
    - name:  name
      value: gitlab-ce
      env:   COMPONENT_NAME
    - name:  namespace
      value: gitlab
      env:   NAMESPACE
    - name:  dbName
      value: gitlab
    - name:  dbUser
      value: gitlab
    - name:  dbPassword
      value: gitlabsekret
    - name:  database
      value: gitlab
    - name:  volume
      value: 8Gi
    - name:  port
      value: 80

outputs:
- name: component.gitlab-ce.git_fqdn
  brief: FQDN of ingress
  value: git.${dns.domain}
- name: component.gitlab-ce.robot.username
  brief: Password for the gitlab robot account
  fromTfVar: gitbot_username
- name: component.gitlab-ce.robot.password
  brief: Password for the gitlab robot account
  fromTfVar: gitbot_password/base64

templates:
  files:
    - "*.yaml.template"
  extra:
  - kind: mustache
    files: ["*.sh.template"]
