---
version: 1
kind: component
meta:
  name: gitlab-ce
  brief: gitlab-ce
  source:
      dir: ../../components/gitlab-ce

provides:
  - gitlab-ce

parameters:
  - name: component.ingress.ssoUrlPrefix
    value: auth
  - name: component.ingress.protocol
    value: https
  - name: component.ingress.fqdn
    value: app.${dns.domain}
    env: INGRESS_FQDN
  - name: kubernetes.oidc_issuer_fqdn
  - name: dns.domain
    env: DOMAIN_NAME
  - name: component.postgresql
    parameters:
    - name: database
    - name: user
    - name: password
    - name: url
  - name: component.gitlab-ce
    parameters:
    - name: acm_certificate.arn
      value: ${component.acm.certificate_arn}
      env: ACM_CERTIFICATE_ARN
    - name:    name
      default: gitlab-ce
      env:     COMPONENT_NAME
    - name:    root-password
      default: gitlab4tw
    - name:    namespace
      default: gitlab
      env:     NAMESPACE
    - name:    dbName
      default: gitlab
    - name:    dbUser
      default: gitlab
    - name:    dbPassword
      default: gitlabsekret
    - name:    database
      default: gitlab
    - name:    volume
      default: 8Gi
    - name:    port
      default: 80

outputs:
- name: component.gitlab-ce.git_fqdn
  brief: FQDN of ingress
  fromTfVar: git_fqdn
- name: component.gitlab-ce.gitbot-password
  brief: Password for the gitbot gitlab robot account
  fromTfVar: gitbot_password
templates:
  files:
    - "*.yaml.template"
  extra:
  - kind: mustache
    files: ["*.sh.template"]
