---
version: 1
kind: component
meta:
  name: k8s-worker-nodes
  brief: Kubernetes worker nodes pool
  source:
    dir: ../../components/k8s-worker-nodes

requires:
  - kubernetes
provides:
  - k8s-worker-nodes

parameters:
  - name: cloud.region
    env: AWS_DEFAULT_REGION
  - name: cloud.sshKey
    env: TF_VAR_keypair
  - name: terraform.bucket.name
    env: STATE_BUCKET
  - name: terraform.bucket.region
    env: STATE_REGION
  - name: dns.domain
    env: TF_VAR_domain

  - name: cloud.vpc.worker.subnet.id
    env: TF_VAR_worker_subnet_id
  - name: cloud.vpc.worker.subnet.ids
    env: TF_VAR_worker_subnet_ids
    empty: allow
  - name: cloud.vpc.worker.sg.id
    env: TF_VAR_worker_sg_id
  - name: cloud.iam.worker.instanceProfile
    env: TF_VAR_worker_instance_profile

  - name: component.k8s-worker-nodes
    parameters:
    - name: count
      env: TF_VAR_worker_count
      value: 1
    - name: size
      env: TF_VAR_worker_instance_type
      value: g3.4xlarge
    - name: spotPrice
      env: TF_VAR_worker_spot_price
      value: 5
    - name: containerLinuxVersionGpu
      env: TF_VAR_container_linux_version_gpu
      value: 1855.4.0
    - name: poolName
      env: TF_VAR_pool_name
      value: gpu3
    - name: asgTags
      env: TF_VAR_autoscaling_group_extra_tags
      value: '[ { key = "k8s.io/cluster-autoscaler/enabled", value = "true", propagate_at_launch = true } ]'
      empty: allow
    - name: asgMaxSize
      value: 6
      env: TF_VAR_autoscaling_group_max_size
    - name: asgMinSize
      value: 0
      env: TF_VAR_autoscaling_group_min_size
