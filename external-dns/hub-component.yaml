---
version: 1
kind: component
meta:
  category: Networking
  name: external-dns
  title: ExternalDNS
  description: >
    Kubernetes addon that configures DNS servers
    with information about exposed Kubernetes
    services to make them discoverable
  license: Apache 2.0
  maturity: beta
  version: 0.5.18
  source:
      dir: ../../components/external-dns

requires:
  - kubernetes
  - helm

provides:
  - external-dns

lifecycle:
  verbs:
  - deploy
  - undeploy

parameters:
- name: cloud.kind
  env:  CLOUD_KIND
- name: cloud.region
# - name: component.tls.kind
- name: dns.domain
  env: DOMAIN_NAME
- name: dns.name
  env: CLUTER_NAME
- name: component.istio
  empty: allow
  parameters:
  - name: namespace
    value: istio-system
  - name: ingressGateway
    # default works well if we have only one instance of an istio
    value: ingressgateway
- name: component.external-dns
  parameters:
  - name: namespace
    value: kube-system
    env: NAMESPACE
  - name: name
    value: external-dns
    env: COMPONENT_NAME
  - name: cloud
    empty: allow
    parameters:
    - name: region
  - name: chart.name
    value: "stable/external-dns"
    env: CHART_NAME
  - name: provider
    value: aws
    env: DNS_PROVIDER
  - name: aws
    empty: allow
    parameters:
    - name: accessKey
    - name: secretKey
  - name: coredns
    empty: allow
    parameters:
      # the http/s endpoint(s) of the etcd server to receive the updates
    - name: etcdEndpoints
    - name: etcd-tls
      empty: allow
      parameters:
      - name: enabled
        value: false
      - name: secretName
      - name: mountPath
      - name: caFilename
      - name: certFilename
      - name: keyFilename
  - name: rfc2136
    empty: allow
    parameters:
    - name: host
    - name: port
      value: 53
    - name: zone
    - name: tsig.secret
    - name: tsig.keyname
    - name: tsig.secret-alg
      value: hmac-sha256
# alias for CEL expression
# - name: externaldns.awsAccessKeyId
#   value: ${component.external-dns.aws.accessKeyId}
# - name: component.external-dns.provider
#   value: '#{size(externaldns.awsAccesKeyId) > 1 ? "aws" : "rfc2136"}'
#   env: SERVICE_PROVIDER

templates:
  files:
    - "examples/*.template"
    - "aws/*.template"
    - "metal/*.template"
    - "./*.template"
