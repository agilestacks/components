---
version: 1
kind: component
meta:
  name: external-dns
  brief: DNS Operator to update route53 for ingresses or Services with the appropriate annotations
  source:
      dir: ../../components/external-dns

requires:
  - kubernetes
  - helm
  - tiller

provides:
  - external-dns

lifecycle:
  verbs:
  - deploy
  - undeploy

parameters:
  - name: dns.name
    env: DOMAIN
  - name: dns.domain
    env: TF_VAR_domain_name
  - name: component.external-dns
    parameters:
    - name: namespace
      value: kube-system
      env: NAMESPACE
    - name: name
      value: external-dns
      env: COMPONENT_NAME
    - name: aws
      empty: allow
      parameters:
      - name: region
      - name: accessKeyId
      - name: secretAccessKey
    - name: rfc2136
      empty: allow
      parameters:
      - name: host
      - name: port
      - name: zone
      - name: tsig-secret
      - name: tsig-secret-keyname
      - name: tsig-secret-alg
        value: hmac-sha256
# alias for CEL expression
- name: externaldns.awsAccessKeyId
  value: ${component.external-dns.aws.accessKeyId}
- name: component.external-dns.provider
  value: '#{size(externaldns.awsAccesKeyId) > 1 ? "aws" : "rfc2136"}'
  env: SERVICE_PROVIDER

templates:
  files:
    - "manifests.yaml.template"
    - "aws/*.template"
    - "metal/*.template"
