---
version: 1
kind: component
meta:
  name: external-dns
  title: External DNS
  brief: DNS Operator to update route53 for ingresses or Services with the appropriate annotations
  source:
      dir: ../../components/external-dns

requires:
  - kubernetes
  - helm

provides:
  - external-dns

lifecycle:
  verbs:
  - deploy
  - undeploy

parameters:
- name: cloud.kind
  env:  CLOUD_KIND
- name: cloud.region
# - name: component.tls.kind
- name: dns.domain
  env: DOMAIN_NAME
- name: dns.name
  env: CLUTER_NAME
- name: component.external-dns
  parameters:
  - name: namespace
    value: default
    env: NAMESPACE
  - name: name
    value: external-dns
    env: COMPONENT_NAME
  - name: cloud
    empty: allow
    parameters:
    - name: region
  - name: chart.version
    # conflicting change https://github.com/helm/charts/commit/396c9d43847e28c62c67c89241d2ce62f5db8d6f
    value: "2.13.1"
    env: CHART_VERSION

  - name: rfc2136
    empty: allow
    parameters:
    - name: host
    - name: port
    - name: zone
    - name: tsig-secret
    - name: tsig-secret-keyname
    - name: tsig-secret-alg
      value: hmac-sha256
# alias for CEL expression
# - name: externaldns.awsAccessKeyId
#   value: ${component.external-dns.aws.accessKeyId}
# - name: component.external-dns.provider
#   value: '#{size(externaldns.awsAccesKeyId) > 1 ? "aws" : "rfc2136"}'
#   env: SERVICE_PROVIDER

templates:
  files:
    - "examples/*.template"
    - "aws/*.template"
