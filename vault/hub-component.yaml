---
version: 1
kind: component
meta:
  name: vault
  brief: Vault a tool for managing secrets
  source:
    dir: ../../components/vault

requires:
  - kubernetes
provides:
  - vault


parameters:
  - name: dns.domain
    brief: DNS domain
    kind: tech
    env: DOMAIN_NAME
  - name: component.ingress.fqdn
  - name: component.vault
    parameters:
    - name:    name
      default: vault-service
      env:     COMPONENT_NAME
    - name:    version
      brief:   vault version
      default: 0.8.1
    - name:    image.repository
      default: vault
    - name:    image.pullPolicy
      default: IfNotPresent
    - name:    replicaCount
      default: 1
    - name:    resources.limits.memory
      default: "128Mi"
    - name:    namespace
      brief: Kubernetes namespace to install into
      default: vault
      env:     NAMESPACE
    - name: port
      brief: Port to listen on
      default: 8200
      env: VAULT_PORT
    - name: ingress.enabled
      brief: Deploy ingress for vault
      env:     INGRESS_ENABLED
      default: false
    - name: ipaddress
      default: "0.0.0.0"
    - name: tls.disabled
      default: 1
    - name: etcd.api
      default: "v3"
    - name: seal.keys
      default: "5"
      env:     SECRET_SHARES
    - name: seal.threshold
      default: "3"
      env:     SECRET_THRESHOLD
  - name: component.etcd
    parameters:
      - name: name
      - name: namespace

outputs:
- name: component.vault.url
  fromTfVar: vault_url
- name: component.vault.token.root
  fromTfVar: root_token
- name: component.vault.unseal.key1
  fromTfVar: unseal_key_1
- name: component.vault.unseal.key2
  fromTfVar: unseal_key_2
- name: component.vault.unseal.key3
  fromTfVar: unseal_key_3
- name: component.vault.unseal.key4
  fromTfVar: unseal_key_4
- name: component.vault.unseal.key5
  fromTfVar: unseal_key_5
- name: component.vault.source_dir
  fromTfVar: component_dir

templates:
  files:
    - "*.template"
